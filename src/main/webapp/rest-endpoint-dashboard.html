<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <title>REST Method Detail â€” CDI Dev Mode</title>

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-funnel@4"></script>

<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    overflow-y: auto;
    background: #f5f5f5;
}

.top, .bottom {
    padding: 20px;
}

.top {
    background: #fafafa;
}

.bottom {
    background: #fff;
    border-top: 1px solid #ddd;
}

h2, h3 {
    margin-top: 0;
}

/* Summary cards */
.summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
}

.card {
    padding: 14px;
    border-radius: 8px;
    color: #fff;
    font-weight: bold;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    justify-content: center;
}

/* Table */
.records-table {
    width: 100%;
    border-collapse: collapse;
}

.records-table th, 
.records-table td {
    padding: 8px;
    border-bottom: 1px solid #e0e0e0;
    text-align: left;
    font-size: 14px;
}

.records-table th {
    background: #f0f0f0;
}

/* Chart containers */
.charts-row {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    align-items: flex-start;
    margin-bottom: 20px;
}

.charts-row canvas {
    flex: 1 1 calc(50% - 10px);
    max-width: calc(50% - 10px);
    height: 400px !important;
    background: #fff;
    border-radius: 8px;
}

/* Doughnut / Pie */
canvas.status-chart {
    flex: 0 0 auto;
    width: 400px !important;
    height: 400px !important;
}

/* Table wrapper */
.charts-row > div {
    flex: 1 1 auto;
    display: flex;
    flex-direction: column;
    max-height: 400px;
}

.table-wrapper {
    flex: 1 1 auto;
    overflow-y: auto;
    margin-top: 10px;
}

/* Optional: chart label improvements */
.chartjs-label {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Responsive tweaks */
@media (max-width: 900px) {
    .charts-row canvas,
    .charts-row > div {
        flex: 1 1 100%;
        max-width: 100%;
    }
}
</style>

    </head>
    <body>

        <div class="top">
            <h2>REST Method Details</h2>
            <div id="meta"></div>

            <h3>Summary</h3>
            <div class="summary-cards" id="summary"></div>

            <!-- Row 1: Duration & Request/Response -->
            <div class="charts-row">
                <canvas id="durationStatusChart"></canvas>
                <canvas id="sizeOverTimeChart"></canvas>
            </div>

            <!-- Row 2: Funnel & Status Distribution -->
            <div class="charts-row">
                <canvas id="funnelChart"></canvas>
                <canvas id="avgDurationChart"></canvas>

            </div>

            <!-- Row 3: Avg Duration & Placeholder -->
            <div class="charts-row">
                <canvas id="statusChart" class="status-chart"></canvas>
                <div>
                    <h3>Recent Calls</h3>
                    <div class="table-wrapper">
                        <table class="records-table" id="recordsTable">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Duration (ms)</th>
                                    <th>Status</th>
                                    <th>Req Size</th>
                                    <th>Res Size</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>


        </div>



        <script>
            function getRestKeyFromURL() {
                const p = new URLSearchParams(window.location.search);
                return p.get("rest");
            }

            async function loadRestDetails() {
                const key = getRestKeyFromURL();
                const url = `/cdi-dev-mode/resources/dev/rest-methods/${encodeURIComponent(key)}`;
                const res = await fetch(url);
                const data = await res.json();

                renderMeta(data);
                renderSummary(data.records);
                renderRecordsTable(data.records);
                renderDurationStatusChart(data.records);
                renderSizeOverTimeChart(data.records);
                renderFunnel(data.records);
                renderStatusChart(data.records);
                renderAvgDurationPerStatus(data.records);
            }
            function formatTimestampHHMMSS(ts) {
                const d = new Date(ts);
                const hours = String(d.getHours()).padStart(2, '0');
                const minutes = String(d.getMinutes()).padStart(2, '0');
                const seconds = String(d.getSeconds()).padStart(2, '0');
                return `${hours}:${minutes}:${seconds}`;
            }

            document.addEventListener("DOMContentLoaded", loadRestDetails);

            function renderMeta(data) {
                document.getElementById("meta").innerHTML = `
                <p><b>HTTP:</b> ${data.httpMethodAndProduces}</p>
                <p><b>Path:</b> ${data.path}</p>
                <p><b>Method:</b> ${data.methodSignature}</p>`;
            }

            function renderSummary(records) {
                if (!records || records.length === 0)
                    return;

                const durations = records.map(r => r.durationMs);
                const min = Math.min(...durations);
                const max = Math.max(...durations);
                const avg = (durations.reduce((a, b) => a + b) / durations.length).toFixed(2);
                const lastCall = records[records.length - 1].timestamp;

                const cardValues = [
                    {label: "Min", value: `${min} ms`},
                    {label: "Avg", value: `${avg} ms`},
                    {label: "Max", value: `${max} ms`},
                    {label: "Total Calls", value: records.length},
                    {label: "Last Call", value: formatTimestampHHMMSS(lastCall)},
                    {label: "99th Percentile", value: `${percentile(durations, 0.99)} ms`}
                ];

                const gradients = [
                    "linear-gradient(135deg,#6a11cb,#2575fc)",
                    "linear-gradient(135deg,#00c6ff,#0072ff)",
                    "linear-gradient(135deg,#43e97b,#38f9d7)",
                    "linear-gradient(135deg,#fa709a,#fee140)",
                    "linear-gradient(135deg,#7F00FF,#E100FF)",
                    "linear-gradient(135deg,#11998e,#38ef7d)"
                ];

                const summaryContainer = document.getElementById("summary");
                summaryContainer.innerHTML = "";

                cardValues.forEach((card, index) => {
                    const div = document.createElement("div");
                    div.className = "card";
                    div.style.background = gradients[index % gradients.length];
                    div.style.color = "#fff"; // text color for contrast
                    div.innerHTML = `<b>${card.label}</b><br>${card.value}`;
                    summaryContainer.appendChild(div);
                });
            }

            function percentile(arr, p) {
                if (!arr.length)
                    return 0;
                const s = [...arr].sort((a, b) => a - b);
                const i = Math.floor(p * s.length);
                return s[Math.min(i, s.length - 1)];
            }

        // -------------------- Duration vs Status --------------------
            let durationStatusChart;
            function renderDurationStatusChart(records) {
                const labels = records.map(r => formatTimestampHHMMSS(r.timestamp));
                const data = records.map(r => r.durationMs);
                const pointColors = records.map(r => {
                    if (r.status >= 500)
                        return '#e53935';
                    if (r.status >= 400)
                        return '#fdd835';
                    return '#43a047';
                });

                const ctx = document.getElementById("durationStatusChart");
                if (durationStatusChart instanceof Chart)
                    durationStatusChart.destroy();

                durationStatusChart = new Chart(ctx, {
                    type: 'line',
                    data: {labels, datasets: [{
                                label: 'Duration (ms)',
                                data,
                                borderColor: '#42a5f5',
                                backgroundColor: '#42a5f5',
                                pointRadius: 5,
                                pointBackgroundColor: pointColors,
                                fill: false,
                                tension: 0.25
                            }]},
                    options: {
                        responsive: true,
                        plugins: {
                            title: {display: true, text: 'Duration over Time (dots color=status)'},
                            legend: {display: true, labels: {generateLabels: chart => [
                                            {text: '2xx Success', fillStyle: '#43a047'},
                                            {text: '4xx Client Error', fillStyle: '#fdd835'},
                                            {text: '5xx Server Error', fillStyle: '#e53935'}
                                        ]}},
                            tooltip: {
                                callbacks: {
                                    label: function (ctx) {
                                        const idx = ctx.dataIndex;
                                        return `Duration: ${ctx.raw} ms, Status: ${records[idx].status}`;
                                    }
                                }
                            }
                        },
                        interaction: {mode: 'nearest', intersect: true},
                        scales: {x: {ticks: {autoSkip: true, maxTicksLimit: 20}}, y: {beginAtZero: true}}
                    }
                });
            }

        // -------------------- Request/Response Size --------------------
            let sizeOverTimeChart;
            function renderSizeOverTimeChart(records) {
                const labels = records.map(r => formatTimestampHHMMSS(r.timestamp));
                const requestSizes = records.map(r => r.requestSize);
                const responseSizes = records.map(r => r.responseSize);

                const ctx = document.getElementById("sizeOverTimeChart");
                if (sizeOverTimeChart instanceof Chart)
                    sizeOverTimeChart.destroy();

                sizeOverTimeChart = new Chart(ctx, {
                    type: 'bar',
                    data: {labels, datasets: [
                            {label: 'Request Size', data: requestSizes, backgroundColor: '#42a5f5'},
                            {label: 'Response Size', data: responseSizes, backgroundColor: '#66bb6a'}
                        ]},
                    options: {responsive: true,
                        plugins: {title: {display: true, text: 'Request & Response Size Over Time'}}
                    }
                });
            }

        // -------------------- FUNNEL --------------------
            let funnelChart;
            function renderFunnel(records) {
                const durations = records.map(r => r.durationMs);
                const values = [Math.max(...durations), percentile(durations, 0.99), percentile(durations, 0.95), percentile(durations, 0.5), Math.min(...durations)];
                const labels = ["Max", "P99", "P95", "Median", "Min"];
                const colors = ["#e53935", "#fb8c00", "#fdd835", "#7cb342", "#43a047"];

                const ctx = document.getElementById("funnelChart");
                if (funnelChart instanceof Chart)
                    funnelChart.destroy();

                funnelChart = new Chart(ctx, {
                    type: 'funnel',
                    data: {labels, datasets: [{data: values, backgroundColor: colors}]},
                    options: {responsive: true,
                        plugins: {title: {display: true, text: 'Duration Funnel'}, legend: {display: false},
                            tooltip: {callbacks: {label: ctx => `${ctx.label}: ${ctx.raw} ms`}}}
                    }
                });
            }

        // -------------------- STATUS --------------------
            let statusChart;
            function renderStatusChart(records) {
                const counts = {};
                records.forEach(r => counts[r.status] = (counts[r.status] || 0) + 1);
                const labels = Object.keys(counts);
                const values = Object.values(counts);
                const colors = labels.map(s => {
                    if (s.startsWith('2'))
                        return '#43a047';
                    if (s.startsWith('4'))
                        return '#fdd835';
                    if (s.startsWith('5'))
                        return '#e53935';
                    return '#90a4ae';
                });

                const ctx = document.getElementById("statusChart");
                if (statusChart instanceof Chart)
                    statusChart.destroy();


                statusChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {labels, datasets: [{data: values, backgroundColor: colors}]},
                    options: {
                        responsive: true,
                        aspectRatio: 1,
                        plugins: {title: {display: true, text: 'Status Distribution'}}
                    }
                });

            }

        // -------------------- AVG Duration --------------------
            let avgDurationChart;
            function renderAvgDurationPerStatus(records) {
                const statusDurations = {};
                records.forEach(r => {
                    if (!statusDurations[r.status])
                        statusDurations[r.status] = [];
                    statusDurations[r.status].push(r.durationMs);
                });
                const labels = Object.keys(statusDurations);
                const values = labels.map(s => statusDurations[s].reduce((a, b) => a + b, 0) / statusDurations[s].length);

                const ctx = document.getElementById("avgDurationChart");
                if (avgDurationChart instanceof Chart)
                    avgDurationChart.destroy();

                avgDurationChart = new Chart(ctx, {
                    type: 'bar',
                    data: {labels, datasets: [{label: 'Avg Duration (ms)', data: values, backgroundColor: '#ffa726'}]},
                    options: {responsive: true, plugins: {title: {display: true, text: 'Average Duration per Status'}}}
                });
            }

        // -------------------- TABLE --------------------
            function renderRecordsTable(records) {
                const tbody = document.querySelector("#recordsTable tbody");
                tbody.innerHTML = "";
                records.forEach(r => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `<td>${r.timestamp}</td><td>${r.durationMs}</td><td>${r.status}</td><td>${r.requestSize}</td><td>${r.responseSize}</td>`;
                    tbody.appendChild(tr);
                });
            }
        </script>
    </body>
</html>
